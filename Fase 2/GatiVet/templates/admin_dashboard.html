<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Mascotas</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/Logo Gativet.png') }}">
    <link rel="stylesheet" href="static/styles/admin_dashboard.css?v=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>


<body class="bg-gray-50">

    <!-- Encabezado con menú horizontal -->
    <header class="bg-white shadow">
        <div class="container mx-auto flex justify-between items-center p-4">
            <!-- Contenedor para el logo y el texto de Administrador -->
            <div class="flex items-center">
                <a href="{{ url_for('home') }}">
                    <img src="{{ url_for('static', filename='img/Logo Gativet.png') }}" alt="Logo Gativet"
                        class="w-14 h-14 mr-2">
                </a>
                <h1 class="text-2xl font-bold" style="color: #18beaa;">Administrador</h1>
            </div>

            <nav>
                <ul class="flex space-x-4">
                    <li><a href="#" onclick="showSection('productos')" class="hover:underline"
                            style="color: #18beaa; border-bottom: 2px solid transparent; transition: border-bottom 0.3s;">
                            Productos</a></li>
                    <li><a href="#" onclick="showSection('usuarios')" class="hover:underline"
                            style="color: #18beaa; border-bottom: 2px solid transparent; transition: border-bottom 0.3s;">
                            Usuarios</a></li>
                    <li><a href="#" onclick="showSection('recordatorios')" class="hover:underline"
                            style="color: #18beaa; border-bottom: 2px solid transparent; transition: border-bottom 0.3s;">
                            Recordatorios</a></li>
                </ul>
            </nav>

        </div>
    </header>


    <!-- Contenido Productos -->
    <div class="container mx-auto flex items-start justify-center pt-10 section hidden" id="productos">
        <section class="p-4 w-full max-w-3xl bg-white shadow-md rounded-lg">
            <!-- Encabezado centrado -->
            <div class="flex justify-center mb-4">
                <h2 class="text-xl font-bold">Gestión de Productos</h2>
            </div>

            <!-- Filtros -->
            <div class="flex justify-between mb-4">
                <div class="flex items-center">
                    <!-- Filtro por Tipo de Producto -->
                    <div class="mr-4">
                        <label for="productFilter" class="mr-1 text-gray-700 text-xs">Filtrar por tipo:</label>
                        <select id="productFilter" class="border rounded py-0.5 px-1 text-gray-700 text-xs"
                            onchange="filterProducts()">
                            <option value="">Todos los tipos</option>
                            <option value="alimento_perro">Alimento para Perros</option>
                            <option value="alimento_gato">Alimento para Gatos</option>
                            <option value="medicamento">Medicamento Veterinario</option>
                        </select>
                    </div>

                    <!-- Filtro por Mes de Ingreso -->
                    <div>
                        <label for="monthFilter" class="mr-1 text-gray-700 text-xs">Filtrar por mes:</label>
                        <input type="month" id="monthFilter" class="border rounded py-1 px-1 text-gray-700 text-xs"
                            onchange="filterByMonth()">
                    </div>
                </div>

                <!-- Botón para exportar a Excel -->
                <button class="text-white py-1 px-3 rounded hover:bg-teal-500 transition duration-200 text-sm"
                    style="background-color: #18beaa;" onclick="exportToExcel()">
                    Exportar a Excel
                </button>
            </div>

            <!-- Tabla de stock de productos -->
            <table class="min-w-full bg-white border border-gray-300 shadow rounded-lg overflow-hidden text-xs mt-3">
                <!-- Cambiar a text-xs -->
                <thead>
                    <tr class="text-white" style="background-color: #18beaa;">
                        <th class="py-1 px-2 border-b">Nombre del Producto</th> <!-- Ajustar padding si es necesario -->
                        <th class="py-1 px-2 border-b">Tipo de Producto</th>
                        <th class="py-1 px-2 border-b">Marca</th>
                        <th class="py-1 px-2 border-b">Precio</th>
                        <th class="py-1 px-2 border-b">Stock</th>
                        <th class="py-1 px-2 border-b">Fecha ingreso</th>
                    </tr>
                </thead>
                <tbody id="productTable">
                    <!-- Aquí se mostrarán los productos filtrados -->
                </tbody>
            </table>


            <!-- Controles de Paginación -->
            <div id="paginationControls" class="mt-4 flex justify-center items-center">
                <button id="prevPageBtn" class="text-white py-1 px-3 rounded mr-2 text-sm"
                    style="background-color: #18beaa;" onclick="prevPage()">
                    &lt;&lt;
                </button>
                <span id="currentPage" class="text-gray-700 text-sm"></span>
                <button id="nextPageBtn" class="text-white py-1 px-3 rounded ml-2 text-sm"
                    style="background-color: #18beaa;" onclick="nextPage()">
                    &gt;&gt;
                </button>
            </div>

            <!-- Formulario para subir productos -->
            <form id="productForm" class="mt-6 bg-white p-6 shadow rounded-lg text-sm">
                <h4 class="text-base font-semibold">Agregar Nuevo Producto</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    <div>
                        <label for="productName" class="block text-gray-700">Nombre del Producto:</label>
                        <input type="text" id="productName" class="border rounded w-full py-1 px-2 text-gray-700"
                            placeholder="Nombre del producto" required>
                        <div id="nameError" class="error hidden">Este campo es obligatorio.</div>
                    </div>
                    <div>
                        <label for="productImage" class="block text-gray-700">Imagen del Producto:</label>
                        <input type="file" id="productImage" class="border rounded w-full py-1 px-2 text-gray-700">
                    </div>
                    <div>
                        <label for="productType" class="block text-gray-700">Tipo de Producto:</label>
                        <select id="productType" class="border rounded w-full py-1 px-2 text-gray-700" required>
                            <option value="">Seleccione un tipo</option>
                            <option value="alimento_perro">Alimento para Perros</option>
                            <option value="alimento_gato">Alimento para Gatos</option>
                            <option value="medicamento">Medicamento Veterinario</option>
                        </select>
                        <div id="typeError" class="error hidden">Este campo es obligatorio.</div>
                    </div>
                    <div>
                        <label for="brand" class="block text-gray-700">Marca:</label>
                        <select id="brand" class="border rounded w-full py-1 px-2 text-gray-700" required>
                            <option value="">Seleccione una marca</option>
                            <optgroup label="Alimento para Perros">
                                <option value="Royal Canin">Royal Canin</option>
                                <option value="Purina Pro Plan">Purina Pro Plan</option>
                                <option value="Pedigree">Pedigree</option>
                                <option value="Eukanuba">Eukanuba</option>
                            </optgroup>
                            <optgroup label="Alimento para Gatos">
                                <option value="Whiskas">Whiskas</option>
                                <option value="Royal Canin">Royal Canin</option>
                                <option value="Purina Cat Chow">Purina Cat Chow</option>
                            </optgroup>
                            <optgroup label="Medicamentos Veterinarios">
                                <option value="NexGard">NexGard</option>
                                <option value="Frontline">Frontline</option>
                                <option value="Advantage">Advantage</option>
                            </optgroup>
                        </select>
                        <div id="brandError" class="error hidden">Este campo es obligatorio.</div>
                    </div>
                    <div>
                        <label for="price" class="block text-gray-700">Precio:</label>
                        <input type="text" id="price" class="border rounded w-full py-1 px-2 text-gray-700"
                            placeholder="Precio del producto" oninput="formatCurrency(this)" required>
                        <div id="priceError" class="error hidden">Este campo es obligatorio.</div>
                    </div>
                    <div>
                        <label for="quantity" class="block text-gray-700">Cantidad:</label>
                        <input type="number" id="quantity" class="border rounded w-full py-1 px-2 text-gray-700"
                            placeholder="Cantidad disponible" required>
                        <div id="quantityError" class="error hidden">Este campo es obligatorio.</div>
                    </div>
                </div>
                <button type="submit"
                    class="mt-4 text-white py-2 px-4 rounded hover:bg-teal-500 transition duration-200"
                    style="background-color: #18beaa;">Subir Producto</button>
            </form>
        </section>
    </div>
    <!-- Fin Contenido Productos -->



<!-- Contenido Gestión de usuarios -->
<div class="container mx-auto flex items-start justify-center pt-10 section hidden" id="usuarios">
    <section class="p-4 w-full max-w-3xl bg-white shadow-md rounded-lg">
        <!-- Encabezado centrado -->
        <div class="flex justify-center mb-4">
            <h2 class="text-xl font-bold">Gestión de Usuarios</h2>
        </div>

        <!-- Buscador de usuarios -->
        <div class="flex justify-between mb-4">
            <div class="flex items-center">
                <div class="mb-4">
                    <label for="search" class="block text-sm font-semibold text-xs">Buscar Usuario:</label>
                    <input type="text" id="search"
                        class="mt-1 block w-full text-xs border-2 border-gray-300 rounded-md focus:border-gray-500 focus:outline-none"
                        placeholder="Buscar por RUT o nombre" oninput="renderUserTable()">
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="flex justify-between mb-4">
            <div class="flex items-center">
                <!-- Filtro por Tipo de Usuario -->
                <div class="mr-4">
                    <label for="filter" class="mr-1 text-gray-700 text-xs">Filtrar por tipo:</label>
                    <select id="filter" class="border rounded py-0.5 px-1 text-gray-700 text-xs"
                        onchange="renderUserTable()">
                        <option value="">Todos los tipos</option>
                        <option value="veterinario">Veterinario</option>
                        <option value="usuario">Usuario</option>
                    </select>
                </div>
            </div>

            <!-- Botón para abrir modal de agregar -->
            <button class="text-white py-1 px-3 rounded hover:bg-teal-500 transition duration-200 text-sm"
                style="background-color: #18beaa;" onclick="openAddUserModal()">
                Agregar Usuario Veterinario
            </button>
        </div>

        <!-- Tabla de usuarios -->
        <table class="min-w-full bg-white border border-gray-300 shadow rounded-lg overflow-hidden text-xs mt-4">
            <thead>
                <tr class="text-white" style="background-color: #18beaa;">
                    <th class="py-1 px-2 border-b">RUT</th>
                    <th class="py-1 px-2 border-b">Nombre</th>
                    <th class="py-1 px-2 border-b">Tipo de Usuario</th>
                    <th class="py-1 px-2 border-b">Fecha de Creación</th> <!-- Nueva columna -->
                    <th class="py-1 px-2 border-b">Acciones</th>
                </tr>
            </thead>
            <tbody id="userTable">
                <!-- Aquí se mostrarán los usuarios -->
            </tbody>
        </table>
    </section>
</div>
<!-- Fin Sección Gestión de Usuarios -->

<!-- Modal para agregar usuario veterinario -->
<div id="addUserModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-md w-80">
        <h2 class="text-lg font-bold mb-4" id="addModalTitle">Agregar Usuario Veterinario</h2>
        <form id="addModalUserForm">
            <div class="mb-4">
                <label for="addModalRut" class="block text-sm font-semibold">RUT:</label>
                <input type="text" id="addModalRut" class="mt-1 block w-full border-gray-300 rounded-md"
                    placeholder="Ingrese el RUT" required>
            </div>
            <div class="mb-4">
                <label for="addModalNombre" class="block text-sm font-semibold">Nombre:</label>
                <input type="text" id="addModalNombre" class="mt-1 block w-full border-gray-300 rounded-md"
                    placeholder="Ingrese el nombre" required>
            </div>
            <!-- Eliminamos el tipo de usuario -->
            <input type="hidden" id="addModalTipo" value="veterinario">
            <div class="flex justify-end">
                <button type="button" class="mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md"
                    onclick="closeAddUserModal()">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md">Guardar</button>
            </div>
        </form>
    </div>
</div>
<!-- Fin del Modal de agregar -->


<!-- Modal para editar usuario veterinario -->
<div id="editUserModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-md w-80">
        <h2 class="text-lg font-bold mb-4" id="editModalTitle">Editar Usuario Veterinario</h2>
        <form id="editModalUserForm">
            <div class="mb-4">
                <label for="editModalRut" class="block text-sm font-semibold">RUT:</label>
                <input type="text" id="editModalRut" class="mt-1 block w-full border-gray-300 rounded-md"
                    placeholder="Ingrese el RUT" required readonly>
            </div>
            <div class="mb-4">
                <label for="editModalNombre" class="block text-sm font-semibold">Nombre:</label>
                <input type="text" id="editModalNombre" class="mt-1 block w-full border-gray-300 rounded-md"
                    placeholder="Ingrese el nombre" required>
            </div>
            <div class="mb-4">
                <label for="editModalTipo" class="block text-sm font-semibold">Tipo de Usuario:</label>
                <select id="editModalTipo" class="mt-1 block w-full border-gray-300 rounded-md">
                    <option value="veterinario">Veterinario</option>
                    <option value="usuario">Usuario</option>
                </select>
            </div>
            <div class="flex justify-end">
                <button type="button" class="mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md"
                    onclick="closeEditUserModal()">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md">Guardar</button>
            </div>
        </form>
    </div>
</div>
<!-- Fin del Modal de editar -->

<!-- Modal de confirmación de eliminación -->
<div id="confirmDeleteModal"
    class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-md w-80 text-center">
        <h2 class="text-lg font-bold mb-4">Confirmar Eliminación</h2>
        <p class="mb-4">¿Estás seguro de que quieres eliminar este usuario? Esta acción no se puede revertir.</p>
        <div class="flex justify-between">
            <button type="button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md"
                onclick="closeConfirmDeleteModal()">Cancelar</button>
            <button type="button" class="px-4 py-2 bg-red-500 text-white rounded-md"
                id="confirmDeleteButton">Eliminar</button>
        </div>
    </div>
</div>
<!-- Fin del Modal de confirmación de eliminación -->

<!-- JavaScript para manejar el formulario y la tabla de usuarios -->
<script>
    const userTable = document.getElementById('userTable');
    const searchInput = document.getElementById('search');
    const filterSelect = document.getElementById('filter');

    let users = [
        {
            rut: "12.345.678-9",
            nombre: "Juan Pérez",
            tipo: "usuario",
            fechaCreacion: "2023-01-15" // Ejemplo de fecha
        },
        {
            rut: "98.765.432-1",
            nombre: "María González",
            tipo: "veterinario",
            fechaCreacion: "2023-02-20" // Ejemplo de fecha
        }
    ];

    let editingUserRut = null; // Variable para almacenar el RUT del usuario que se está editando

    function renderUserTable() {
        userTable.innerHTML = '';

        const filteredUsers = users.filter(user => {
            const searchMatch = user.rut.includes(searchInput.value) || user.nombre.includes(searchInput.value);
            const filterMatch = filterSelect.value === '' || user.tipo === filterSelect.value;
            return searchMatch && filterMatch;
        });

        filteredUsers.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-1 px-2 border-b">${user.rut}</td>
                <td class="py-1 px-2 border-b">${user.nombre}</td>
                <td class="py-1 px-2 border-b">${user.tipo}</td>
                <td class="py-1 px-2 border-b">${user.fechaCreacion}</td> <!-- Nueva columna -->
                <td class="py-1 px-2 border-b">
                    <button class="text-blue-500 hover:underline" onclick="openEditUserModal('${user.rut}')">Editar</button>
                    <button class="text-red-500 hover:underline" onclick="confirmDeleteUser('${user.rut}')">Eliminar</button>
                </td>
            `;
            userTable.appendChild(row);
        });
    }

    function openAddUserModal() {
        document.getElementById('addUserModal').classList.remove('hidden');
    }

    function closeAddUserModal() {
        document.getElementById('addUserModal').classList.add('hidden');
        document.getElementById('addModalUserForm').reset();
    }

    document.getElementById('addModalUserForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const rut = document.getElementById('addModalRut').value;
        const nombre = document.getElementById('addModalNombre').value;
        const tipo = document.getElementById('addModalTipo').value;

        users.push({ rut, nombre, tipo, fechaCreacion: new Date().toISOString().slice(0, 10) });
        closeAddUserModal();
        renderUserTable();
    });

    function openEditUserModal(rut) {
        const user = users.find(u => u.rut === rut);
        if (user) {
            document.getElementById('editModalRut').value = user.rut;
            document.getElementById('editModalNombre').value = user.nombre;
            document.getElementById('editModalTipo').value = user.tipo;
            editingUserRut = rut; // Almacena el RUT del usuario a editar
            document.getElementById('editUserModal').classList.remove('hidden');
        }
    }

    function closeEditUserModal() {
        document.getElementById('editUserModal').classList.add('hidden');
        document.getElementById('editModalUserForm').reset();
    }

    document.getElementById('editModalUserForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const nombre = document.getElementById('editModalNombre').value;
        const tipo = document.getElementById('editModalTipo').value;

        const userIndex = users.findIndex(u => u.rut === editingUserRut);
        if (userIndex !== -1) {
            users[userIndex].nombre = nombre;
            users[userIndex].tipo = tipo;
        }
        closeEditUserModal();
        renderUserTable();
    });

    function confirmDeleteUser(rut) {
        document.getElementById('confirmDeleteModal').classList.remove('hidden');
        document.getElementById('confirmDeleteButton').onclick = function () {
            deleteUser(rut);
        };
    }

    function deleteUser(rut) {
        users = users.filter(user => user.rut !== rut);
        closeConfirmDeleteModal();
        renderUserTable();
    }

    function closeConfirmDeleteModal() {
        document.getElementById('confirmDeleteModal').classList.add('hidden');
    }

    // Cargar la tabla de usuarios al iniciar
    renderUserTable();
</script>




<!-- Sección de Administración de Recordatorios -->
<div class="container mx-auto flex items-start justify-center pt-10 section hidden" id="recordatorios">
    <section class="p-4 w-full max-w-3xl bg-white shadow-md rounded-lg">
        <h2 class="text-2xl font-bold">Administrar Recordatorios</h2>
        <p>Aquí puedes ver y gestionar los recordatorios de mascotas.</p>

        <div id="recordatoriosList" class="mt-4">
            <!-- Aquí se cargarán los recordatorios -->
        </div>
    </section>
</div>
<!-- Fin Sección de Administración de Recordatorios -->

<!-- Script para obtener y mostrar los recordatorios -->
<script>
    async function obtenerRecordatorios() {
        try {
            const response = await fetch('/api/get-recordatorios'); // Asegúrate de que esta ruta esté disponible en tu backend
            const recordatorios = await response.json();
            mostrarRecordatorios(recordatorios);
        } catch (error) {
            console.error('Error al obtener los recordatorios:', error);
        }
    }

    function mostrarRecordatorios(recordatorios) {
        const recordatoriosList = document.getElementById('recordatoriosList');
        recordatoriosList.innerHTML = '';

        if (recordatorios.length === 0) {
            recordatoriosList.innerHTML = '<p class="text-gray-500">No hay recordatorios disponibles.</p>';
            return;
        }

        recordatorios.forEach(recordatorio => {
            const recordatorioDiv = document.createElement('div');
            recordatorioDiv.classList.add('border p-4 mb-4 rounded-md shadow');

            recordatorioDiv.innerHTML = `
                <h3 class="text-lg font-semibold">${recordatorio.mascota}</h3>
                <p><strong>Correo Electrónico:</strong> ${recordatorio.email}</p>
                <p><strong>Fecha de Vacunación:</strong> ${new Date(recordatorio.fechaVacuna).toLocaleDateString()}</p>
                <p><strong>Fecha de Desparasitaciones:</strong> ${new Date(recordatorio.fechaDesparacitacion).toLocaleDateString()}</p>
                <p><strong>Fecha de Cita:</strong> ${new Date(recordatorio.fechaCita).toLocaleString()}</p>
                <button onclick="eliminarRecordatorio('${recordatorio._id}')" class="mt-2 py-1 px-3 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button>
            `;

            recordatoriosList.appendChild(recordatorioDiv);
        });
    }

    async function eliminarRecordatorio(id) {
        if (confirm('¿Estás seguro de que deseas eliminar este recordatorio?')) {
            try {
                const response = await fetch(`/api/delete-recordatorio/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('Recordatorio eliminado exitosamente.');
                    obtenerRecordatorios(); // Volver a cargar la lista
                } else {
                    alert('Error al eliminar el recordatorio.');
                }
            } catch (error) {
                console.error('Error al eliminar el recordatorio:', error);
            }
        }
    }

    // Cargar recordatorios al iniciar
    document.addEventListener('DOMContentLoaded', obtenerRecordatorios);
</script>




    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"> </script>
</body>